<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pyodide Widget with Plot</title>

  <style>
    body { font-family: Arial, sans-serif; padding: 12px; }
    textarea { width: 100%; height: 190px; font-family: monospace; font-size: 14px; }
    button { padding: 10px 14px; margin-top: 10px; cursor: pointer; }
    pre { background: #f4f4f4; padding: 10px; min-height: 60px; white-space: pre-wrap; }
    #plot { max-width: 100%; border: 1px solid #ccc; border-radius: 8px; margin-top: 8px; }
    .status { margin: 8px 0; }
  </style>

  <!-- Pyodide runtime -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
</head>

<body>
  <h3>Pyodide Python Widget (with matplotlib)</h3>

  <div class="status" id="status">Loading Python runtime...</div>

  <textarea id="code">
import numpy as np
import matplotlib.pyplot as plt

# Parameters
initial_velocity = 0  # initial velocity in meters per second
acceleration = 1.0  # constant acceleration in meters per second squared
time_end = 10  # end time in seconds
num_points = 1000  # number of points in the time array

# Time array
time = np.linspace(0, time_end, num_points)

# Kinematic equations for distance and speed
distance = initial_velocity * time + 0.5 * acceleration * time**2
speed = initial_velocity + acceleration * time

# Plotting
plt.figure(figsize=(12, 6))

# Plot for distance vs time
plt.subplot(1, 2, 1)
plt.plot(time, distance, label='Distance (m)', color='blue')
plt.xlabel('Time (s)')
plt.ylabel('Distance (m)')
plt.title('Distance vs Time')
plt.grid(True)
plt.legend()

# Plot for speed vs time
plt.subplot(1, 2, 2)
plt.plot(time, speed, label='Speed (m/s)', color='red')
plt.xlabel('Time (s)')
plt.ylabel('Speed (m/s)')
plt.title('Speed vs Time')
plt.grid(True)
plt.legend()

plt.tight_layout()

  </textarea>

  <br/>
  <button id="runBtn" disabled>Run</button>

  <h4>Output</h4>
  <pre id="output"></pre>

  <h4>Plot</h4>
  <img id="plot" alt="Plot will appear here"/>

<script>
let pyodideReady = (async () => {
  const status = document.getElementById("status");
  status.textContent = "Loading Pyodide...";

  window.pyodide = await loadPyodide();

  status.textContent = "Loading packages (numpy, matplotlib)...";
  await pyodide.loadPackage(["numpy", "matplotlib"]);

  // Prepare Python-side helpers:
  // 1) redirect print() to the <pre>
  // 2) function to export matplotlib figure as base64 PNG
  pyodide.runPython(`
import sys, io, base64
import matplotlib.pyplot as plt
from js import document

class _Catcher:
    def write(self, s):
        out = document.getElementById("output")
        out.textContent = out.textContent + s
    def flush(self): pass

def _export_plot_base64():
    buf = io.BytesIO()
    plt.savefig(buf, format="png", bbox_inches="tight", dpi=150)
    buf.seek(0)
    return base64.b64encode(buf.read()).decode("utf-8")
  `);

  status.textContent = "Ready.";
  document.getElementById("runBtn").disabled = false;
})();

async function runPython() {
  const outputEl = document.getElementById("output");
  const plotEl = document.getElementById("plot");
  const code = document.getElementById("code").value;

  outputEl.textContent = "";
  plotEl.removeAttribute("src");

  await pyodideReady;

  // Redirect stdout/stderr each run
  pyodide.runPython(`
import sys
sys.stdout = _Catcher()
sys.stderr = _Catcher()
plt.close("all")
  `);

  try {
    // Run user's code (should create a plot)
    await pyodide.runPythonAsync(code);

    // Export the plot and display it
    const imgData = pyodide.runPython(`_export_plot_base64()`);
    plotEl.src = "data:image/png;base64," + imgData;

  } catch (err) {
    outputEl.textContent += "\nERROR:\n" + err;
  }
}

document.getElementById("runBtn").addEventListener("click", runPython);
</script>
</body>
</html>
